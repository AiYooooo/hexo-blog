---
layout: post
title: "qs.stringify({})包含数组导致的问题解决"
date: 2018-11-29
author: "Ai Shuangying"
tags:
	- Node.js
---

----------

[新手向 Vue + Node.js + MongoDB 实现自己的账务管理系统](https://github.com/AiYooooo/Ai-Finance)

这两天自己的记账网站突然出现了一个问题，很怪异，比如一个时间列表，期望的存储形式是数组：

```
	[
		"2018-08-05", 
        "2018-08-12", 
        "2018-08-19", 
        "2018-08-26", 
        "2018-09-02", 
        "2018-09-09", 
        "2018-09-16", 
        "2018-09-23", 
        "2018-09-30", 
        "2018-10-07", 
        "2018-10-14", 
        "2018-10-21", 
        "2018-10-28", 
        "2018-11-04", 
        "2018-11-11", 
        "2018-11-18", 
        "2018-11-25"
	]
```

可是存储之后到数据库里就变成了 

```
	[
		{
			"0":"2018-08-05", 
	        "1":"2018-08-12", 
	        "2":"2018-08-19", 
	        "3":"2018-08-26", 
	        "4":"2018-09-02", 
	        "5":"2018-09-09", 
	        "6":"2018-09-16", 
	        "7":"2018-09-23", 
	        "8":"2018-09-30", 
	        "9":"2018-10-07", 
	        "10":"2018-10-14", 
	        "11":"2018-10-21", 
	        "12":"2018-10-28", 
	        "13":"2018-11-04", 
	        "14":"2018-11-11", 
	        "15":"2018-11-18", 
	        "16":"2018-11-25"
	    }
	]
```


### 问题筛查
-------------

经过筛查，问题出现在qs模块格式化过程中，服务器拿到的数据解码后类型错误

```
	客户端发送：qs.stringify(data)
	服务端接手：req.body = qs.parse(req.body);
```

判断结果是qs格式化对数组的支持有问题。

奇怪的是，当数组数量较少时是可以正常传递的，只有数组数量超过某个值才会出现这种键名格式化的情况。

### 解决办法
-------------

最简单粗暴的解决办法就是在qs格式化之前把数组数据JSON格式化下

```
	客户端发送：	data = JSON.stringify(data);
				qs.stringify(data)
	服务端接手：	req.body = qs.parse(req.body);
				req.body = JSON.parse(req.body);
```

但是这显然不是一个优秀的解决办法，究根结底是传入的数组并不是严格的json对象导致的，才会出现默认键的键值对的格式化结果。

这里还要注意的是，不管数组大小都要进行JSON字符串话，否则在服务端进行解码的时候就会发生错误。

#### arrayFormat解决办法

```
	qs.stringify({ 'list':this.excelData },{ arrayFormat: 'brackets' })
	// arrayFormat 可以格式化你的数组参数

	arrayformat选项输出 指定数组的格式
　　	qs.stringify({ id: ['b', 'c'] }, { arrayFormat: 'indices' })
　　		// 'id[0]=b&id[1]=c'
　　	qs.stringify({ id: ['b', 'c'] }, { arrayFormat: 'brackets' })
　　		// 'id[]=b&id[]=c'
　　	qs.stringify({ id: ['b', 'c'] }, { arrayFormat: 'repeat' })
　　		// 'id=b&id=c'
```

这里有一个问题就是当对二维数组进行处理时，解码后会变为一维数组。
